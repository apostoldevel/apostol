worker_processes auto;
worker_rlimit_nofile 1048576;

error_log /dev/stderr warn;
pid /var/run/nginx.pid;

events {
    worker_connections 512;
    multi_accept on;
}

http {
    access_log off;
    sendfile off;
    etag off;
    max_ranges 0;
    if_modified_since off;
    add_header Last-Modified "";

    default_type application/json;
    charset utf-8;

    keepalive_timeout 65;
    keepalive_requests 10000;

    resolver 127.0.0.11 valid=10s ipv6=off;

    server {
        listen 80 backlog=4096;
        server_name _;

        # v0 — nginx baseline (static responses)
        location = /api/v0/ping {
            return 200 '{"ok":true,"message":"OK"}';
        }
        location = /api/v0/time {
            return 200 '{"serverTime":1700000000}';
        }
        location = /api/v0/db/ping {
            return 200 '{"ok":true,"message":"OK"}';
        }
        location = /api/v0/db/time {
            return 200 '{"serverTime":1700000000}';
        }

        # v1 — Apostol
        location ^~ /api/v1/ {
            set $upstream_apostol bench-apostol;
            proxy_pass http://$upstream_apostol:8080;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header Connection "close";
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # v2 — Python (FastAPI)
        location ^~ /api/v2/ {
            set $upstream_python bench-python;
            proxy_pass http://$upstream_python:8000;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header Connection "close";
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # v3 — Node.js (Fastify)
        location ^~ /api/v3/ {
            set $upstream_node bench-node;
            proxy_pass http://$upstream_node:3000;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header Connection "close";
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # v4 — Go
        location ^~ /api/v4/ {
            set $upstream_go bench-go;
            proxy_pass http://$upstream_go:4000;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header Connection "close";
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}
